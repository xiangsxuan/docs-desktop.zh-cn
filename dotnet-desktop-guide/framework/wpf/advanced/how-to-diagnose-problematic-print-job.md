---
title: 如何：诊断有问题的打印作业
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
- cpp
helpviewer_keywords:
- troubleshooting print job problems [WPF]
- print jobs [WPF], troubleshooting
- print jobs [WPF], diagnosing problems
ms.assetid: b081a170-84c6-48f9-a487-5766a8d58a82
ms.openlocfilehash: ce79818b16824969ef0bd2a9c8adfd7ca094cec0
ms.sourcegitcommit: bf5dd80f4d7b202afa90e90d1148402c5474d826
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 03/30/2021
ms.locfileid: "96970597"
---
# <a name="how-to-diagnose-problematic-print-job"></a><span data-ttu-id="07b87-102">如何：诊断有问题的打印作业</span><span class="sxs-lookup"><span data-stu-id="07b87-102">How to: Diagnose Problematic Print Job</span></span>
<span data-ttu-id="07b87-103">网络管理员经常接收到有关打印作业无法打印或打印速度慢的用户投诉。</span><span class="sxs-lookup"><span data-stu-id="07b87-103">Network administrators often field complaints from users about print jobs that do not print or print slowly.</span></span> <span data-ttu-id="07b87-104">Microsoft .NET 框架的 Api 中公开的一组丰富的打印作业属性提供了一种快速远程诊断打印作业的方法。</span><span class="sxs-lookup"><span data-stu-id="07b87-104">The rich set of print job properties exposed in the APIs of Microsoft .NET Framework provide a means for performing a rapid remote diagnosis of print jobs.</span></span>  
  
## <a name="example"></a><span data-ttu-id="07b87-105">示例</span><span class="sxs-lookup"><span data-stu-id="07b87-105">Example</span></span>  
 <span data-ttu-id="07b87-106">以下是创建此类实用程序的主要步骤。</span><span class="sxs-lookup"><span data-stu-id="07b87-106">The major steps for creating this kind of utility are as follows.</span></span>  
  
1. <span data-ttu-id="07b87-107">标识用户投诉的打印作业。</span><span class="sxs-lookup"><span data-stu-id="07b87-107">Identify the print job that the user is complaining about.</span></span> <span data-ttu-id="07b87-108">用户通常无法准确完成此操作。</span><span class="sxs-lookup"><span data-stu-id="07b87-108">Users often cannot do this precisely.</span></span> <span data-ttu-id="07b87-109">他们可能不知道打印服务器或打印机的名称。</span><span class="sxs-lookup"><span data-stu-id="07b87-109">They may not know the names of the print servers or printers.</span></span> <span data-ttu-id="07b87-110">它们可能会描述打印机的位置，而不是在设置其属性时使用的术语 <xref:System.Printing.PrintQueue.Location%2A> 。</span><span class="sxs-lookup"><span data-stu-id="07b87-110">They may describe the location of the printer in different terminology than was used in setting its <xref:System.Printing.PrintQueue.Location%2A> property.</span></span> <span data-ttu-id="07b87-111">这样的话，一个好办法是生成用户当前所提交作业的列表。</span><span class="sxs-lookup"><span data-stu-id="07b87-111">Accordingly, it is a good idea to generate a list of the user's currently submitted jobs.</span></span> <span data-ttu-id="07b87-112">如果存在多个作业，则可通过用户和打印系统管理员之间的通信来查明出现问题的作业。</span><span class="sxs-lookup"><span data-stu-id="07b87-112">If there is more than one, then communication between the user and the print system administrator can be used to pinpoint the job that is having problems.</span></span> <span data-ttu-id="07b87-113">子步骤如下。</span><span class="sxs-lookup"><span data-stu-id="07b87-113">The substeps are as follows.</span></span>  
  
    1. <span data-ttu-id="07b87-114">获取所有打印服务器的列表。</span><span class="sxs-lookup"><span data-stu-id="07b87-114">Obtain a list of all print servers.</span></span>  
  
    2. <span data-ttu-id="07b87-115">循环访问服务器以查询其打印队列。</span><span class="sxs-lookup"><span data-stu-id="07b87-115">Loop through the servers to query their print queues.</span></span>  
  
    3. <span data-ttu-id="07b87-116">在每一轮服务器循环访问过程中，循环访问所有服务器的队列，以查询其作业</span><span class="sxs-lookup"><span data-stu-id="07b87-116">Within each pass of the server loop, loop through all the server's queues to query their jobs</span></span>  
  
    4. <span data-ttu-id="07b87-117">在每一轮服务器循环访问过程中，循环访问其作业，并收集与投诉用户已提交的作业相关的标识信息。</span><span class="sxs-lookup"><span data-stu-id="07b87-117">Within each pass of the queue loop, loop through its jobs and gather identifying information about those that were submitted by the complaining user.</span></span>  
  
2. <span data-ttu-id="07b87-118">当已识别有问题的打印作业时，检查相关属性以查明可能的问题。</span><span class="sxs-lookup"><span data-stu-id="07b87-118">When the problematic print job has been identified, examine relevant properties to see what might be the problem.</span></span> <span data-ttu-id="07b87-119">例如，作业是否处于错误状态，或服务于队列的打印机是否在打印该作业之前处于脱机状态？</span><span class="sxs-lookup"><span data-stu-id="07b87-119">For example, is job in an error state or did the printer servicing the queue go offline before the job could print?</span></span>  
  
 <span data-ttu-id="07b87-120">以下代码是一系列代码示例。</span><span class="sxs-lookup"><span data-stu-id="07b87-120">The code below is series of code examples.</span></span> <span data-ttu-id="07b87-121">第一个代码示例包含针对打印队列的循环访问操作。</span><span class="sxs-lookup"><span data-stu-id="07b87-121">The first code example contains the loop through the print queues.</span></span> <span data-ttu-id="07b87-122"> (以上步骤1c。 ) 变量 `myPrintQueues` 是 <xref:System.Printing.PrintQueueCollection> 当前打印服务器的对象。</span><span class="sxs-lookup"><span data-stu-id="07b87-122">(Step 1c above.) The variable `myPrintQueues` is the <xref:System.Printing.PrintQueueCollection> object for the current print server.</span></span>  
  
 <span data-ttu-id="07b87-123">此代码示例通过使用刷新当前打印队列对象开始 <xref:System.Printing.PrintQueue.Refresh%2A?displayProperty=nameWithType> 。</span><span class="sxs-lookup"><span data-stu-id="07b87-123">The code example begins by refreshing the current print queue object with <xref:System.Printing.PrintQueue.Refresh%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="07b87-124">这可确保该对象的属性能够准确表示它所表示的物理打印机的状态。</span><span class="sxs-lookup"><span data-stu-id="07b87-124">This ensures that the object's properties accurately represent the state of the physical printer that it represents.</span></span> <span data-ttu-id="07b87-125">然后，应用程序通过使用获取打印队列中当前的打印作业的集合 <xref:System.Printing.PrintQueue.GetPrintJobInfoCollection%2A> 。</span><span class="sxs-lookup"><span data-stu-id="07b87-125">Then the application gets the collection of print jobs currently in the print queue by using <xref:System.Printing.PrintQueue.GetPrintJobInfoCollection%2A>.</span></span>  
  
 <span data-ttu-id="07b87-126">接下来，应用程序循环遍历该 <xref:System.Printing.PrintSystemJobInfo> 集合，并将每个 <xref:System.Printing.PrintSystemJobInfo.Submitter%2A> 属性与抱怨用户的别名进行比较。</span><span class="sxs-lookup"><span data-stu-id="07b87-126">Next the application loops through the <xref:System.Printing.PrintSystemJobInfo> collection and compares each <xref:System.Printing.PrintSystemJobInfo.Submitter%2A> property with the alias of the complaining user.</span></span> <span data-ttu-id="07b87-127">如果属性和别名相匹配，则应用程序会将有关该作业的标识信息添加到将呈现的字符串。</span><span class="sxs-lookup"><span data-stu-id="07b87-127">If they match, the application adds identifying information about the job to the string that will be presented.</span></span> <span data-ttu-id="07b87-128">（`userName` 和 `jobList` 变量在应用程序早期进行初始化。）</span><span class="sxs-lookup"><span data-stu-id="07b87-128">(The `userName` and `jobList` variables are initialized earlier in the application.)</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#EnumerateJobsInQueues](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#enumeratejobsinqueues)]
 [!code-csharp[DiagnoseProblematicPrintJob#EnumerateJobsInQueues](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#enumeratejobsinqueues)]
 [!code-vb[DiagnoseProblematicPrintJob#EnumerateJobsInQueues](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#enumeratejobsinqueues)]  
  
 <span data-ttu-id="07b87-129">下一代码示例在步骤 2 提取应用程序。</span><span class="sxs-lookup"><span data-stu-id="07b87-129">The next code example picks up the application at Step 2.</span></span> <span data-ttu-id="07b87-130"> (参见上文。 ) 已确定有问题的作业，并且应用程序提示输入将标识该作业的信息。</span><span class="sxs-lookup"><span data-stu-id="07b87-130">(See above.) The problematic job has been identified and the application prompts for the information that will identify it.</span></span> <span data-ttu-id="07b87-131">通过此信息，它将创建 <xref:System.Printing.PrintServer> 、 <xref:System.Printing.PrintQueue> 和 <xref:System.Printing.PrintSystemJobInfo> 对象。</span><span class="sxs-lookup"><span data-stu-id="07b87-131">From this information it creates <xref:System.Printing.PrintServer>, <xref:System.Printing.PrintQueue>, and <xref:System.Printing.PrintSystemJobInfo> objects.</span></span>  
  
 <span data-ttu-id="07b87-132">此时，应用程序包含一个分支结构，该结构对应于检查打印作业状态的两种方法：</span><span class="sxs-lookup"><span data-stu-id="07b87-132">At this point the application contains a branching structure corresponding to the two ways of checking a print job's status:</span></span>  
  
- <span data-ttu-id="07b87-133">您可以读取 <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> 类型为的属性的标志 <xref:System.Printing.PrintJobStatus> 。</span><span class="sxs-lookup"><span data-stu-id="07b87-133">You can read the flags of the <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> property which is of type <xref:System.Printing.PrintJobStatus>.</span></span>  
  
- <span data-ttu-id="07b87-134">您可以读取每个相关属性 <xref:System.Printing.PrintSystemJobInfo.IsBlocked%2A> ，例如和 <xref:System.Printing.PrintSystemJobInfo.IsInError%2A> 。</span><span class="sxs-lookup"><span data-stu-id="07b87-134">You can read each relevant property such as <xref:System.Printing.PrintSystemJobInfo.IsBlocked%2A> and <xref:System.Printing.PrintSystemJobInfo.IsInError%2A>.</span></span>  
  
 <span data-ttu-id="07b87-135">此示例演示了这两种方法，因此，如果用户想要使用属性的标志，则以前会提示用户要使用哪种方法并使用 "Y" 做出响应 <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> 。</span><span class="sxs-lookup"><span data-stu-id="07b87-135">This example demonstrates both methods, so the user was previously prompted as to which method to use and responded with "Y" if they wanted to use the flags of the <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> property.</span></span> <span data-ttu-id="07b87-136">请参阅以下有关这两种方法的详细信息。</span><span class="sxs-lookup"><span data-stu-id="07b87-136">See below for the details of the two methods.</span></span> <span data-ttu-id="07b87-137">最后，该应用程序使用一种名为 **ReportQueueAndJobAvailability** 的方法来报告是否可以在一天的此时打印该作业。</span><span class="sxs-lookup"><span data-stu-id="07b87-137">Finally, the application uses a method called **ReportQueueAndJobAvailability** to report on whether the job can be printed at this time of day.</span></span> <span data-ttu-id="07b87-138">[确定此时是否可以打印一项打印作业](how-to-discover-whether-a-print-job-can-be-printed-at-this-time-of-day.md)中就此方法进行了讨论。</span><span class="sxs-lookup"><span data-stu-id="07b87-138">This method is discussed in [Discover Whether a Print Job Can Be Printed At This Time of Day](how-to-discover-whether-a-print-job-can-be-printed-at-this-time-of-day.md).</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#IdentifyAndDiagnoseProblematicJob](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#identifyanddiagnoseproblematicjob)]
 [!code-csharp[DiagnoseProblematicPrintJob#IdentifyAndDiagnoseProblematicJob](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#identifyanddiagnoseproblematicjob)]
 [!code-vb[DiagnoseProblematicPrintJob#IdentifyAndDiagnoseProblematicJob](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#identifyanddiagnoseproblematicjob)]  
  
 <span data-ttu-id="07b87-139">若要使用属性的标志来检查打印作业状态 <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> ，请检查每个相关标志是否已设置。</span><span class="sxs-lookup"><span data-stu-id="07b87-139">To check print job status using the flags of the <xref:System.Printing.PrintSystemJobInfo.JobStatus%2A> property, you check each relevant flag to see if it is set.</span></span> <span data-ttu-id="07b87-140">检查是否在一组位标志中设置了一个位的标准方法是执行一个逻辑 AND 运算，其中将该组标志作为一个操作数，将标志本身作为另一操作数。</span><span class="sxs-lookup"><span data-stu-id="07b87-140">The standard way to see if one bit is set in a set of bit flags is to perform a logical AND operation with the set of flags as one operand and the flag itself as the other.</span></span> <span data-ttu-id="07b87-141">由于该标志本身仅设置一个位，因此逻辑 AND 的结果至多为设置了该相同位。</span><span class="sxs-lookup"><span data-stu-id="07b87-141">Since the flag itself has only one bit set, the result of the logical AND is that, at most, that same bit is set.</span></span> <span data-ttu-id="07b87-142">若要查明事实是否如此，只需将逻辑 AND 的结果与标志本身进行比较。</span><span class="sxs-lookup"><span data-stu-id="07b87-142">To find out whether it is or not, just compare the result of the logical AND with the flag itself.</span></span> <span data-ttu-id="07b87-143">有关详细信息，请参阅 <xref:System.Printing.PrintJobStatus> [& 运算符 (c # 参考) ](/dotnet/csharp/language-reference/operators/bitwise-and-shift-operators#logical-and-operator-)和 <xref:System.FlagsAttribute> 。</span><span class="sxs-lookup"><span data-stu-id="07b87-143">For more information, see <xref:System.Printing.PrintJobStatus>, the [& Operator (C# Reference)](/dotnet/csharp/language-reference/operators/bitwise-and-shift-operators#logical-and-operator-), and <xref:System.FlagsAttribute>.</span></span>  
  
 <span data-ttu-id="07b87-144">对于已设置了其位的每个属性，代码会将此报告给控制台屏幕，有时还会建议如何响应。</span><span class="sxs-lookup"><span data-stu-id="07b87-144">For each attribute whose bit is set, the code reports this to the console screen and sometimes suggests a way to respond.</span></span> <span data-ttu-id="07b87-145">（下面讨论了作业或队列暂停时所调用的 **HandlePausedJob** 方法。）</span><span class="sxs-lookup"><span data-stu-id="07b87-145">(The **HandlePausedJob** method that is called if the job or queue is paused is discussed below.)</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#SpotTroubleUsingJobAttributes](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#spottroubleusingjobattributes)]
 [!code-csharp[DiagnoseProblematicPrintJob#SpotTroubleUsingJobAttributes](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#spottroubleusingjobattributes)]
 [!code-vb[DiagnoseProblematicPrintJob#SpotTroubleUsingJobAttributes](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#spottroubleusingjobattributes)]  
  
 <span data-ttu-id="07b87-146">若要使用单独的属性检查打印作业状态，只需读取每个属性，如果属性为 `true`，则报告给控制台屏幕，并建议一种可能的响应方式。</span><span class="sxs-lookup"><span data-stu-id="07b87-146">To check print job status using separate properties, you simply read each property and, if the property is `true`, report to the console screen and possibly suggest a way to respond.</span></span> <span data-ttu-id="07b87-147">（下面讨论了作业或队列暂停时所调用的 **HandlePausedJob** 方法。）</span><span class="sxs-lookup"><span data-stu-id="07b87-147">(The **HandlePausedJob** method that is called if the job or queue is paused is discussed below.)</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#SpotTroubleUsingJobProperties](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#spottroubleusingjobproperties)]
 [!code-csharp[DiagnoseProblematicPrintJob#SpotTroubleUsingJobProperties](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#spottroubleusingjobproperties)]
 [!code-vb[DiagnoseProblematicPrintJob#SpotTroubleUsingJobProperties](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#spottroubleusingjobproperties)]  
  
 <span data-ttu-id="07b87-148">使用 **HandlePausedJob** 方法，应用程序的用户能够远程恢复暂停的作业。</span><span class="sxs-lookup"><span data-stu-id="07b87-148">The **HandlePausedJob** method enables the application's user to remotely resume paused jobs.</span></span> <span data-ttu-id="07b87-149">由于可能存在一个充分的暂停打印队列的理由，因此该方法会首先提示用户是否确实要恢复该作业。</span><span class="sxs-lookup"><span data-stu-id="07b87-149">Because there might be a good reason why the print queue was paused, the method begins by prompting for a user decision about whether to resume it.</span></span> <span data-ttu-id="07b87-150">如果回答是 "Y"，则 <xref:System.Printing.PrintQueue.Resume%2A?displayProperty=nameWithType> 调用方法。</span><span class="sxs-lookup"><span data-stu-id="07b87-150">If the answer is "Y", then the <xref:System.Printing.PrintQueue.Resume%2A?displayProperty=nameWithType> method is called.</span></span>  
  
 <span data-ttu-id="07b87-151">接下来，系统会提示用户是否确实要继续执行作业，这么做是考虑到这个作业可能是独立于队列中的其他作业被单独暂停的。</span><span class="sxs-lookup"><span data-stu-id="07b87-151">Next the user is prompted to decide if the job itself should be resumed, just in case it is paused independently of the print queue.</span></span> <span data-ttu-id="07b87-152"> (比较 <xref:System.Printing.PrintQueue.IsPaused%2A?displayProperty=nameWithType> 和 <xref:System.Printing.PrintSystemJobInfo.IsPaused%2A?displayProperty=nameWithType> 。 ) 如果答案是 "Y"，则 <xref:System.Printing.PrintSystemJobInfo.Resume%2A?displayProperty=nameWithType> 调用; 否则 <xref:System.Printing.PrintSystemJobInfo.Cancel%2A> ，将调用。</span><span class="sxs-lookup"><span data-stu-id="07b87-152">(Compare <xref:System.Printing.PrintQueue.IsPaused%2A?displayProperty=nameWithType> and <xref:System.Printing.PrintSystemJobInfo.IsPaused%2A?displayProperty=nameWithType>.) If the answer is "Y", then <xref:System.Printing.PrintSystemJobInfo.Resume%2A?displayProperty=nameWithType> is called; otherwise <xref:System.Printing.PrintSystemJobInfo.Cancel%2A> is called.</span></span>  
  
 [!code-cpp[DiagnoseProblematicPrintJob#HandlePausedJob](~/samples/snippets/cpp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CPP/Program.cpp#handlepausedjob)]
 [!code-csharp[DiagnoseProblematicPrintJob#HandlePausedJob](~/samples/snippets/csharp/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/CSharp/Program.cs#handlepausedjob)]
 [!code-vb[DiagnoseProblematicPrintJob#HandlePausedJob](~/samples/snippets/visualbasic/VS_Snippets_Wpf/DiagnoseProblematicPrintJob/visualbasic/program.vb#handlepausedjob)]  
  
## <a name="see-also"></a><span data-ttu-id="07b87-153">另请参阅</span><span class="sxs-lookup"><span data-stu-id="07b87-153">See also</span></span>

- <xref:System.Printing.PrintJobStatus>
- <xref:System.Printing.PrintSystemJobInfo>
- <xref:System.FlagsAttribute>
- <xref:System.Printing.PrintQueue>
- [<span data-ttu-id="07b87-154">& 运算符 (c # 参考) </span><span class="sxs-lookup"><span data-stu-id="07b87-154">& Operator (C# Reference)</span></span>](/dotnet/csharp/language-reference/operators/bitwise-and-shift-operators#logical-and-operator-)
- [<span data-ttu-id="07b87-155">WPF 中的文档</span><span class="sxs-lookup"><span data-stu-id="07b87-155">Documents in WPF</span></span>](documents-in-wpf.md)
- [<span data-ttu-id="07b87-156">打印概述</span><span class="sxs-lookup"><span data-stu-id="07b87-156">Printing Overview</span></span>](printing-overview.md)
